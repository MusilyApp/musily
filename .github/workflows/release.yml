name: Build and Release Flutter App

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  metadata:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      description: ${{ steps.extract_description.outputs.description }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: extract_version
        run: |
          version=$(chmod +x musily_metadata.sh && ./musily_metadata.sh --version)
          echo "version=${version}" >> $GITHUB_OUTPUT

      - name: Extract description
        id: extract_description
        run: |
          description=$(chmod +x musily_metadata.sh && ./musily_metadata.sh --description)
          escaped_description="${description//'%'/'%25'}"
          escaped_description="${escaped_description//$'\n'/'%0A'}"
          escaped_description="${escaped_description//$'\r'/'%0D'}"
          echo "description=${escaped_description}" >> $GITHUB_OUTPUT

  build:
    needs: metadata
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    env:
      BUILD_DIR_LINUX: build/linux/x64/release/bundle

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.29.3"

      - name: Set up Java
        if: matrix.os == 'ubuntu-latest'
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17.x"

      - name: Install dependencies
        run: flutter pub get

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl git unzip xz-utils zip \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libglu1-mesa \
            libstdc++-12-dev libmpv-dev \
            libjsoncpp-dev libsecret-1-dev \
            libayatana-appindicator3-dev

      - name: Build APK (Android)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "${{ secrets.KEY_PROPERTIES_BASE64 }}" | base64 --decode > android/key.properties
          echo "${{ secrets.KEY_STORE_BASE64 }}" | base64 --decode > android/app/key.jks
          flutter build apk --release --flavor stable

      - name: Build Linux
        if: matrix.os == 'ubuntu-latest'
        run: flutter build linux --release

      - name: Archive Linux build
        if: matrix.os == 'ubuntu-latest'
        run: |
          tar -czvf build/musily-linux-x64.tar.gz -C $BUILD_DIR_LINUX .

      - name: Build Windows
        if: matrix.os == 'windows-latest'
        run: flutter build windows --release

      - name: Set up Python
        if: matrix.os == 'windows-latest'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Archive Windows build using Python
        if: matrix.os == 'windows-latest'
        run: |
          python -c "import shutil; shutil.make_archive('build/musily-windows-x64', 'zip', 'build/windows/x64/runner/Release')"


      - name: Build macOS
        if: matrix.os == 'macos-latest'
        run: flutter build macos --release

      - name: Archive macOS build
        if: matrix.os == 'macos-latest'
        run: |
          ditto -c -k --sequesterRsrc --keepParent build/macos/Build/Products/Release/musily.app build/musily-macos-x64.zip

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Flutter-Build-${{ matrix.os }}
          path: |
            build/*.zip
            build/*.tar.gz
            build/app/outputs/flutter-apk/*.apk

  release:
    needs: [metadata, build]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Rename APK file
        run: |
          apk_path=$(find dist -name "*.apk" | head -n 1)
          new_apk_name="musily-${{ needs.metadata.outputs.version }}.apk"
          mv "$apk_path" "dist/$new_apk_name"
        shell: bash

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          tag_name: ${{ needs.metadata.outputs.version }}
          name: Release ${{ needs.metadata.outputs.version }}
          body: "${{ needs.metadata.outputs.description }}"
          files: |
            dist/**/*.zip
            dist/**/*.tar.gz
            dist/musily-${{ needs.metadata.outputs.version }}.apk
